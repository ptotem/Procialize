<%= content_for :page_title do %>
    New Message
<% end %>

<%= content_for :page_menu do %>

<% end %>

<%= content_for :head do %>
    <script type="text/javascript">

        $(function(){

            $('[type="submit"]').button('disable');
            $(function () {
                $('[type="submit"]').button('disable');
                $('select').change && $('#message_body').focus (function () {
                    if (($('select option:selected') && $('#message_body')).length > 0) {
                        $('[type="submit"]').button('enable');

                    } else {
                        $('[type="submit"]').button('disable');

                    }
                });

            });

            $('#message_body').blur(function () {
                if ($(this).val().length <= 0) {
                    $('[type="submit"]').button('disable');
                }
                else{
                    $('[type="submit"]').button('enable');
                }
            });

        }) ;





    </script>
<% end %>





<%= form_for :message,:html => { :id => "message_form" },  :url => {:action => :create} do |f| %>

    <%= f.hidden_field :conference_id, :value => Conference.last.id %>
    <%= f.hidden_field :user_id, :value => current_user.id %>

    <!--<div data-role="controlgroup" data-mini="true"  data-placeholder="true">-->
      <!--<%#= select_tag 'receipient_users[]', options_for_select(@user_list),:prompt =>"Select Delegates", :multiple => true,:'data-mini' => true %>-->
    <!--</div>-->


    <div class="field">
      <%= f.text_area :body, :rows => '5', :placeholder => "Type your message",:'data-mini' => true %>
    </div>

<% end %>
 <br>
 <br>
<div data-role="collapsible" data-theme="a" data-collapsed="true" data-collapsed-icon="arrow-r" data-expanded-icon="arrow-d" data-inset="false" data-mini="true" data-filter="true">
  <h3 style="font-size: 0.8em;"><div  id="search_delegates" class="search_dele">Select Recepients</div></h3>
  <ul data-role="listview" data-theme="a" data-divider-theme="d"  data-split-icon='star' data-mini="true" data-filter="true">
    <% @users = User.all  %>
    <% @use = @users - [current_user]  %>
    <% @use.sort_by(&:name).each_with_index do |e,index| %>
        <% @a=1 %>
        <li id="<%= e.id %>" class="li_delegate" data-filtertext=" <%= e.name %> <%= e.role %> <%= e.headline %> <%= e.industry %> <%= e.company %> <%= e.location %> <%= e.email %> <%= e.skills %> <%= e.interest %>"  >
          <div data-role="fieldcontain">
            <fieldset data-role="controlgroup">
              <label id="delegates_name"><input type="checkbox" name="checkbox-0" class=" checking_checkbox"/><%= e.name %></label>
            </fieldset>
          </div>
        </li>
    <% end %>
  </ul>
</div>
<br>
<br>
<div data-role="controlgroup" data-type="horizontal" style="float: right;">
  <%#= f.submit "Send", :'data-role' => "button", :'data-ajax' => "false",:'data-mini' => true %>
  <a class="index_styling" href="#" data-ajax=false data-role="button" class="form_btn" id="form_btn_id" data-mini="true">Send</a>
</div>

<script type="text/javascript">
    $(document).on("pageinit", function(){
        $( ".checking_checkbox" ).on( "change", function() {
            if ( $( this ).attr( "checked" ) === "checked" ) {

                var adding = ($(this).parent().parent().parent().parent().parent().attr('id'));
                var b = ($(this).parent().parent().find('#delegates_name').text());
                $('#search_delegates').text().replace(/Select Recepients/, "");
                $('#search_delegates').html($('#search_delegates').text().replace(/Select Recepients/, "") + b + ", ");
                $('#message_form').append('<input id=' + adding + ' type="hidden" name="receipient_users[]" value=' + adding + '>');
            }
            else {

                var deleting = ($(this).parent().parent().parent().parent().parent().attr('id'))
                var string = $(this).parent().parent().find('#delegates_name').text();
                var new_string = $('#search_delegates').text().replace(string + ",", '');
                $('#search_delegates').text(new_string);
                if ($('#search_delegates').text()==" ") {
                    $('#search_delegates').text("Select Recepients");
                }
                $('#message_form').find('#' + deleting).empty().remove();
            }
        });
    });


    $(function () {
        $('#form_btn_id').on('click', function(){
            if (($(":checkbox").filter(":checked").size()==0))
            {
            <%= add_gritter("Please select Delegates", :title => "Error!",:image => :warning,:time => 2000  ) %>
            }

            else if ($('#message_body').val()==""){
            <%= add_gritter("Please fill Message", :title => "Error!",:image => :warning,:time => 2000  ) %>
            }
            else
            {

                $('#message_form').submit();
            }
            $('#form_btn_id').hide();
        });


    });

</script>


